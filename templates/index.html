<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Analyzer - Researcher Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
        .result-section {
            display: none;
        }
        .result-section.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-video text-3xl"></i>
                    <h1 class="text-3xl font-bold">AI Video Analyzer</h1>
                </div>
                <div class="text-sm opacity-90">
                    <i class="fas fa-brain mr-2"></i>
                    Researcher Tool Powered by NB Media
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Upload Section -->
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-upload mr-3 text-blue-600"></i>
                    Upload Video or Enter URL
                </h2>
                
                <!-- Analysis Description -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex">
                        <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-medium mb-2">Investigative Analysis Features:</p>
                            <p><strong>Metadata Extraction:</strong> Date, Address/Location, City/State/County, Police Department</p>
                            <p><strong>Timestamp Categories:</strong> 911 Calls, CCTV Footage, Interrogation, Bodycam Footage, Investigation, and complete Summary & Storyline</p>
                        </div>
                    </div>
                </div>
                
                <form id="videoForm" action="/upload" method="post" enctype="multipart/form-data">

                    <!-- Custom Prompt -->
                    <div class="mb-6">
                        <label for="custom_prompt" class="block text-sm font-medium text-gray-700 mb-2">
                            Additional Analysis Requirements (Optional)
                        </label>
                        <textarea 
                            id="custom_prompt" 
                            name="custom_prompt" 
                            rows="4" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter any specific requirements for the analysis... (e.g., 'Focus on license plates and vehicle movements' or 'Pay special attention to conversations and statements')"
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            The system will automatically extract metadata (date, location, police department) and timestamps for 911 calls, CCTV footage, interrogation, bodycam footage, and investigation. Add specific requirements here if you need particular focus areas.
                        </p>
                    </div>

                    <!-- Upload Options -->
                    <div class="mb-6">
                        <div class="flex space-x-4 mb-4">
                            <button type="button" id="fileTab" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="fas fa-upload mr-2"></i>Upload File
                            </button>
                            <button type="button" id="urlTab" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                <i class="fas fa-link mr-2"></i>Enter URL
                            </button>
                        </div>

                        <!-- File Upload -->
                        <div id="fileUpload" class="upload-section">
                            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-lg text-gray-600 mb-2">Choose a video file to upload</p>
                                <p class="text-sm text-gray-500 mb-4">Only MP4 video files are accepted</p>
                                <input type="file" id="video_file" name="video_file" accept="video/mp4,.mp4" class="hidden" required>
                                <button type="button" onclick="document.getElementById('video_file').click()" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Select Video File
                                </button>
                                <p id="fileInfo" class="text-sm text-gray-600 mt-2"></p>
                                <!-- Upload progress -->
                                <div id="uploadProgressContainer" class="hidden mt-6 text-left">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">Upload Progress</span>
                                        <span id="uploadProgressText" class="text-sm text-gray-600">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="uploadProgressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- URL Input -->
                        <div id="urlUpload" class="upload-section hidden">
                            <div class="space-y-4">
                                <div>
                                    <label for="video_url" class="block text-sm font-medium text-gray-700 mb-2">
                                        Video URL
                                    </label>
                                    <input 
                                        type="url" 
                                        id="video_url" 
                                        name="video_url" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="https://example.com/video.mp4 or YouTube URL"
                                    >
                                </div>
                                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                                    <div class="flex">
                                        <i class="fas fa-info-circle text-yellow-600 mt-0.5 mr-3"></i>
                                        <div class="text-sm text-yellow-800">
                                            <p class="font-medium">Note:</p>
                                            <p>For YouTube videos, make sure the video is publicly accessible. Some videos may not be downloadable due to restrictions.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-6 rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200">
                        <i class="fas fa-play mr-2"></i>
                        Analyze Video
                    </button>
                </form>
            </div>

            <!-- Loading Section -->
            <div id="loadingSection" class="loading bg-white rounded-lg shadow-lg p-8 mb-8">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Analyzing Video...</h3>
                    <p class="text-gray-600">This may take a few minutes depending on video length and complexity.</p>
                    <div class="mt-4 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="result-section bg-white rounded-lg shadow-lg p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-chart-line mr-3 text-green-600"></i>
                        Analysis Results
                    </h3>
                    <button id="downloadBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <i class="fas fa-download mr-2"></i>Download Report
                    </button>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h4 class="font-semibold text-gray-800 mb-4">Video Information & Metadata</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-medium text-gray-700 mb-2">Technical Details</h5>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <span class="text-gray-600">Duration:</span>
                                    <span id="videoDuration" class="ml-2 font-medium">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Frames Analyzed:</span>
                                    <span id="framesAnalyzed" class="ml-2 font-medium">-</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Analysis Mode:</span>
                                    <span id="analysisType" class="ml-2 font-medium">Investigative Categories</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h5 class="font-medium text-gray-700 mb-2">Extracted Metadata</h5>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <span class="text-gray-600">📅 Date:</span>
                                    <span id="extractedDate" class="ml-2 font-medium text-blue-600">Will be extracted from video</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">📍 Location:</span>
                                    <span id="extractedLocation" class="ml-2 font-medium text-blue-600">Will be extracted from video</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">🏛️ Police Dept:</span>
                                    <span id="extractedDepartment" class="ml-2 font-medium text-blue-600">Will be extracted from video</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="prose max-w-none">
                    <h4 class="font-semibold text-gray-800 mb-4">Investigative Timestamp Analysis</h4>
                    <div id="analysisResults" class="bg-white border rounded-lg p-6 whitespace-pre-wrap text-gray-700 leading-relaxed"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">
                <i class="fas fa-shield-alt mr-2"></i>
                Researcher Tool Powered by NB Media - Secure and Private Analysis
            </p>
        </div>
    </footer>

    <script>
        // Tab switching
        document.getElementById('fileTab').addEventListener('click', function() {
            document.getElementById('fileUpload').classList.remove('hidden');
            document.getElementById('urlUpload').classList.add('hidden');
            this.classList.add('bg-blue-600', 'hover:bg-blue-700');
            this.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            document.getElementById('urlTab').classList.add('bg-gray-600', 'hover:bg-gray-700');
            document.getElementById('urlTab').classList.remove('bg-blue-600', 'hover:bg-blue-700');

            // Toggle required fields
            document.getElementById('video_file').required = true;
            const urlInput = document.getElementById('video_url');
            if (urlInput) urlInput.required = false;
        });

        document.getElementById('urlTab').addEventListener('click', function() {
            document.getElementById('urlUpload').classList.remove('hidden');
            document.getElementById('fileUpload').classList.add('hidden');
            this.classList.add('bg-blue-600', 'hover:bg-blue-700');
            this.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            document.getElementById('fileTab').classList.add('bg-gray-600', 'hover:bg-gray-700');
            document.getElementById('fileTab').classList.remove('bg-blue-600', 'hover:bg-blue-700');

            // Toggle required fields
            document.getElementById('video_file').required = false;
            const urlInput = document.getElementById('video_url');
            if (urlInput) urlInput.required = true;
        });

        // File selection handling
        document.getElementById('video_file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileInfo').textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            }
        });

        // Drag & drop support
        const dropZone = document.getElementById('dropZone');
        if (dropZone) {
            ['dragenter', 'dragover'].forEach(evt => dropZone.addEventListener(evt, e => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('border-blue-400');
            }));

            ['dragleave', 'drop'].forEach(evt => dropZone.addEventListener(evt, e => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-blue-400');
            }));

            dropZone.addEventListener('drop', e => {
                const files = e.dataTransfer.files;
                if (files && files[0]) {
                    const input = document.getElementById('video_file');
                    input.files = files;
                    document.getElementById('fileInfo').textContent = `Selected: ${files[0].name} (${(files[0].size / 1024 / 1024).toFixed(2)} MB)`;
                }
            });
        }

        // Form submission
        document.getElementById('videoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const fileInput = document.getElementById('video_file');
            const urlInput = document.getElementById('video_url');
            
            // Validate input
            if (!fileInput.files[0] && !urlInput.value.trim()) {
                alert('Please select a video file or enter a video URL');
                return;
            }
            
            const hasFile = !!fileInput.files[0];

            // If uploading a file, use XHR to track upload progress
            if (hasFile) {
                const uploadProgressContainer = document.getElementById('uploadProgressContainer');
                const uploadProgressBar = document.getElementById('uploadProgressBar');
                const uploadProgressText = document.getElementById('uploadProgressText');

                uploadProgressContainer.classList.remove('hidden');
                uploadProgressBar.style.width = '0%';
                uploadProgressText.textContent = '0%';

                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/upload');

                    xhr.upload.onprogress = function (event) {
                        if (event.lengthComputable) {
                            const percent = Math.round((event.loaded / event.total) * 100);
                            uploadProgressBar.style.width = percent + '%';
                            uploadProgressText.textContent = percent + '%';
                        }
                    };

                    // When upload completes (request body fully sent), switch to analyzing spinner
                    xhr.upload.onload = function () {
                        uploadProgressContainer.classList.add('hidden');
                        document.getElementById('loadingSection').classList.add('show');
                        document.getElementById('resultsSection').classList.remove('show');
                    };

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4) {
                            try {
                                const data = JSON.parse(xhr.responseText || '{}');
                                if (xhr.status >= 200 && xhr.status < 300 && data.success) {
                                    // Populate results
                                    document.getElementById('analysisResults').textContent = data.analysis;
                                    document.getElementById('videoDuration').textContent = `${data.duration.toFixed(2)}s`;
                                    document.getElementById('framesAnalyzed').textContent = data.frames_analyzed;
                                    document.getElementById('analysisType').textContent = 'Investigative Categories';
                                    parseAndDisplayMetadata(data.analysis);
                                    document.getElementById('resultsSection').classList.add('show');
                                    document.getElementById('loadingSection').classList.remove('show');
                                    resolve();
                                } else {
                                    alert('Error: ' + (data.error || 'Upload failed'));
                                    uploadProgressContainer.classList.add('hidden');
                                    resolve();
                                }
                            } catch (e) {
                                alert('Error: ' + e.message);
                                uploadProgressContainer.classList.add('hidden');
                                resolve();
                            }
                        }
                    };

                    xhr.onerror = function () {
                        alert('Network error during upload');
                        uploadProgressContainer.classList.add('hidden');
                        reject(new Error('Network error'));
                    };

                    xhr.send(formData);
                });
            } else {
                // URL-based analysis: no upload progress, just show analyzing state
                document.getElementById('loadingSection').classList.add('show');
                document.getElementById('resultsSection').classList.remove('show');
                try {
                    const response = await fetch('/upload', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('analysisResults').textContent = data.analysis;
                        document.getElementById('videoDuration').textContent = `${data.duration.toFixed(2)}s`;
                        document.getElementById('framesAnalyzed').textContent = data.frames_analyzed;
                        document.getElementById('analysisType').textContent = 'Investigative Categories';
                        parseAndDisplayMetadata(data.analysis);
                        document.getElementById('resultsSection').classList.add('show');
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    document.getElementById('loadingSection').classList.remove('show');
                }
            }
        });

        // Parse and display metadata from analysis results
        function parseAndDisplayMetadata(analysisText) {
            const lines = analysisText.split('\n');
            let date = 'Not found';
            let location = 'Not found';
            let department = 'Not found';
            
            for (let line of lines) {
                const trimmedLine = line.trim();
                
                // Look for metadata patterns
                if (trimmedLine.toLowerCase().includes('date:')) {
                    date = trimmedLine.replace(/.*date:\s*/i, '').trim() || 'Not found';
                } else if (trimmedLine.toLowerCase().includes('address/location:')) {
                    location = trimmedLine.replace(/.*address\/location:\s*/i, '').trim() || 'Not found';
                } else if (trimmedLine.toLowerCase().includes('police department:')) {
                    department = trimmedLine.replace(/.*police department:\s*/i, '').trim() || 'Not found';
                }
            }
            
            // Update the display
            document.getElementById('extractedDate').textContent = date;
            document.getElementById('extractedLocation').textContent = location;
            document.getElementById('extractedDepartment').textContent = department;
        }

        // Download functionality
        document.getElementById('downloadBtn').addEventListener('click', function() {
            const analysis = document.getElementById('analysisResults').textContent;
            const videoInfo = document.getElementById('videoDuration').textContent;
            const frames = document.getElementById('framesAnalyzed').textContent;
            const type = document.getElementById('analysisType').textContent;
            
            const report = `AI Video Analysis Report
========================

Video Information:
- Duration: ${videoInfo}
- Frames Analyzed: ${frames}
- Analysis Type: ${type}

Analysis Results:
${analysis}

Generated by AI Video Analyzer
Timestamp: ${new Date().toLocaleString()}`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `video_analysis_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
